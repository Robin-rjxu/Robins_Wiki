---
title: StrongArm 比较器
toc: true
date: 2020-02-17 11:34:38
tags:
    - IC
    - ADC
    - comparator
---

## 关键 Keypoints

StrongARM 锁存器的

- 基本结构和原理
  - 组成：钟控开关，输入差分对，交叉耦合对
  - 工作过程
    - 4 个工作阶段
      - 预充电 (钟控开关 $S_1-S_4$)
      - 放大 (输入差分对 $M_1,M_2$)
      - 再生输出
        - 放大：$M_3,M_4$ 交叉耦合 NMOS 导通
        - 正反馈：$M_5,M_6$ 交叉耦合 PMOS 导通
  - 各个晶体管的作用
    - $M_3,M_4$ 切断静态电流
    - $M_5,M_6$ 恢复输出高电平
    - $S_1,S_2$ 清除状态，设置放大模式初始状态
    - $M_8$ 保证 $P,Q$ 电压相等，避免动态失调
    - $S_3,S_4$ 预充电
- 非理想性分析
  - 失调
    - $M_1,M_2$ 贡献主要失调
    - 其他晶体管对失调的贡献受到输入参考电压增益抑制
    - 主要失调校正原理：调整 $P,Q$ 的电容，实现不同的放电速率，以补偿随机失调误差
  - 电噪声
    - 噪声机制
      - $M_1,M_2$ 和 $kT/C$ 贡献主要噪声
      - 其他晶体管对噪声的贡献受到输入参考电压增益抑制
    - 噪声仿真方法
      - 输入小差分电压差
      - 处于亚稳态条件附近
      - 统计瞬态仿真输出 0/1 出现的次数
      - 倒推输入参考噪声的高斯分布方差
  - 回踢
    - 锁存器工作时从输入汲取电流
    - 通过电容耦合回输入
  - 电源瞬态
    - 锁存器工作时可能从电源汲取峰值较大电流

## 背景 Backgroud

StrongARM 锁存器拓扑可广泛用作 Sense Amplifier，比较器，或者作为是具有高灵敏度的锁存器。 "StrongARM" 一词是为了纪念 Digital Equipment Corporation 的 StrongARM 微处理器中使用此电路，但其基本结构最初是由东芝的 Kobayashi 等人介绍的。 StrongARM 锁存器之所以流行，有以下三个原因：

1. 零静态功率；
2. 直接产生轨到轨输出；
3. 其输入参考失调主要来自一对差分。

## 概述 Overview

Fig.1 (a) 显示了原始的 StrongARM 锁存器，(b) 为其中一种修改，其中的锁存器包括一对钟控的差分对 $M_1 - M_2$，两个交叉耦合对 $M_3 - M_4$ 和 $M_5 - M_6$，以及4个预充电开关 $S_1 - S_4$。

![strongarm_fig1.png](https://i.loli.net/2020/02/27/Wf4mG2Arz1n8Lp3.png)

## 工作过程 Operation

根据输入 $V_{in1}-V_{in2}$ 的极性，电路在 X 和 Y 节点提供输出轨到轨的输出。我们可以将其工作描述为 4 个阶段。

**第一阶段**， $CK$ 为低；$M_1$ 和 $M_2$ 关断，$P, Q, X, Y$ 被预充电至 $VDD$，电路可以简化至 Fig.2(a) 所示。

**第二阶段**，$CK$ 变为高，开关 $S_1 - S_4$ 关断，$M_1$ 和 $M_2$ 导通，汲取与 $V_{in1}-V_{in2}$ 成正比的电流。由于 $M_3 - M_6$ 原来为关断，电流从 $C_P$ 和 $C_Q$ 流出，使得 $|V_P-V_Q|$ 升高，并且可能超过 $|V_{in1}-V_{in2}|$，即这个阶段可以提供电压增益，称之为放大模式，如 Fig.2(b) 所示。因为该阶段尾电流相对恒定，$|V_P-V_Q|\approx(g_{m1,2}|V_{in1}-V_{in2}|/C_{P,Q})t$，其中 $g_{m1,2}$ 为 $M_1$ 和 $M_2$ 的小信号跨导，$C_{P,Q}=C_P=C_Q$。

**第三阶段**，随着 $V_P$ 和 $V_Q$ 下降至低于 $V_{DD}-V_{THN}$，交叉耦合的 NMOS 管导通，$M_1$ 和 $M_2$ 的部分漏电流从 $X,Y$ 流出，如 Fig.2(c) 所示。放大模式的持续时间约为 $(C_{P,Q}/I_{CM})V_{THN}$，其中 $I_{CM}$ 为每个电容中流出的共模电流。此时，电压增益大约为 $A_V \approx \dfrac{g_{m1,2}V_{THN}}{I_{CM}}$。锁存器在第三阶段的行为可以通过 Fig.2(d) 中的等效电路进行分析。锁存器的再生过程是形式为 $exp(t/\tau_{reg})$ 的自然响应，其中 $\tau_{reg}$ 为再生时间常数，即 $\tau_{reg} = \dfrac{C_{X,Y}}{g_{m3,4}(1-C_{X,Y}/C_{P,Q})}$。有趣的是，$C_{P}$ 和 $C_{Q}$ 造成的退化，以系数 $(1-C_{X,Y}/C_{P,Q})$ 增加了 $\tau_{reg}$。实际上，由于 $C_{X,Y}$ 包括了比较器后级电路的输入电容，因此会大于 $C_{P,Q}$，交叉耦合的 NMOS 管在这一阶段只提供较小的退化。

**第四阶段**，输出电压 $V_X, V_Y$ 继续下降直至 $V_{DD}-|V_{THP}|$，此时 $M_5 , M_6$ 导通，如 Fig.2(e) 所示，交叉耦合管的正反馈使得一个输出回到 $V_{DD}$，而另一个继续下降到 0。

StrongARM 锁存器在其中半个时钟的输出是无效的 $V_X=V_Y=V_{DD}$，为了保证后续的逻辑，需要在其后使用 RS锁存器。

StrongARM 锁存器的功耗主要来源于节点电容的充放电，大约为 $f_{CK} \cdot (2\cdot C_{P,Q}+C_{X,Y}\cdot V_{DD})$，其中 $f_{CK}$ 为时钟频率，系数 2 表示 $P,Q$ 两个节点每个周期都会从 $V_{DD}$ 放电至地。

![strongarm_fig2.png](https://i.loli.net/2020/02/27/4hVAPcISgRvxHuU.png)

## 分析讨论 Analysis

### 各个晶体管的作用

- $M_3-M_4$ 切断第四阶段结束 $V_{DD}$ 和 地 之间的直流路径，避免静态的漏电流。如 Fig.3 所示，如果没有$M_3$ 和 $M_4$，假设在共模电压附近 $V_{in1}-V_{in2}=100 mV$， 当时钟有效时，$V_X$ 下降 $V_Y$ 上升，$M_5$ 关断，但是 $M_6$ 导通，从 $V_{DD}$ 到地存在静态电流。若输入为轨到轨的电压，$|V_{in1}-V_{in2}|=V_{DD}$，$M_1$ 和 $M_2$ 不会同时导通，则不存在该现象。

- $M_5-M_6$ 主要用于恢复输出节点$X, Y$ 到 $V_{DD}$，如果没有它们，当 $|V_{in1}-V_{in2}|$ 很小时，共模电压会从 $X$ 或 $Y$ 放电，输出的高电平被衰减。

- 开关 $S_1, S_2$ 主要有两个作用
  - 清除 $P,Q$ 之前的状态，避免动态失调；
  - 为各个节点提供初始电压 $V_{DD}$，使得在 $M_1,M_2$进入线性区之前提供放大模式。

- Fig.1(a) 和 Fig.1(b) 的主要区别：是否使 $P,Q$ 电压相等
  - 预充电结束后，$M_8$ 会关断
  - 如果没有 $M_8$
    - 动态失调会更严重
    - $V_P$ 和 $V_Q$ 会从 $V_{DD}-V_{THN}$ 开始放电，电路只能提供很小的增益
    - $M_3-M_4$ 会在增益实现前导通，因此会贡献更多的失调

- $S_3-S_4$ 将 $X, Y$ 预充电至 $V_{DD}$，保证 $M_5-M_6$ 在放大开始之前保持关断，从而减少他们对失调的贡献

![strongarm_fig3.png](https://i.loli.net/2020/02/28/MmDN9IYGflZbjQv.png)

### 非理想性分析

#### 失调 offset

当用作 sense amplifier 时，需要 StrongARM 实现足够小的输入等效失调电压。由于 $S_1-S_4$ 实现的预充电保证了在 $M_3-M_6$ 在初始状态下关断，减少了他们对失调的贡献。在一个典型的设计中,$M_3,M_4$ 的失配参考到输入端，除以的系数约为 $A_V\approx 4$，而 $M_5,M_6$ 的系数约为 10，这样 $M_1,M_2$ 成为失调的主导。

因为放大模式中，$C_{P,Q}$ 的电荷流动提供了电压增益，因此可以通过制造 $C_P\ne C_Q$ 的不对称消除电路的失调。如 Fig.5 所示，通过在 $P,Q$ 建立不同的放电速率实现失调调整。其中 $P,Q$ 之间的电压差可以写作：

$$V_P - V_Q = -\dfrac{g_{m1,2}}{2}\cdot \dfrac{C_P+C_Q}{C_P C_Q}(V_{in1}-V_{in2})t+\dfrac{C_P-C_Q}{C_P C_Q}I_{CM}t$$

可见放大模式时，$V_P-V_Q$ 可以累积的电压失调为 $(C_P-C_Q)/(C_P C_Q)I_{CM}t$，用于补偿锁存器的随机失调。当 $V_P,V_Q$ 下降至低于 $V_{DD}-V_{THN}$ 后，放大模式结束，其持续的时间约为 $t\approx V_{THN}(C_P+C_Q)/(2I_{CM}$，其中 $(C_P+C_Q)/2$ 为近似值，因此其贡献的失调为 $V_{THN}(C_P/C_Q-C_Q/C_P)/2$。

为了实现失调消除，锁存器的输入端短接在一起，当时钟有效时，锁存器输出寄存器，调整 $C_P,C_Q$ 的值。如果要实现大范围，高精度的失调消除，需要数量较多，取值较小单位电容，造成锁存器工作速度的下降和功耗的提高。

![strongarm_fig5.png](https://i.loli.net/2020/02/28/ysZXlu3K17qABUI.png)

#### 电噪声 electronic noise

##### 噪声分析

根据前面的失调分析可知，$S_1-S_4$ 的预充电行为也会减少 $M_3-M_6$的电噪声贡献。主要的输入参考噪声来源于 $M_1-M_2$，$kT/C$ 噪声则存在于 $S_1-S_2$，而其他晶体管的噪声只在增益显著增长后才会开始作用。

在放大模式中，如 Fig.2(b) 所示，该等效电路可以看作一个积分器，输出来自 $M_1-M_2$ 的噪声。这部分噪声的方差随着时间增长：
$$E(V_{PQ}^2)=\dfrac{8kT\gamma g_{m1,2}}{C_{Q,P}^2}t$$

放大模式持续的时间约为 $(C_{P,Q}/I_{CM}V_{THN})$，$M_1-M_2$ 在该模式下最终输出的噪声方差为：

$$\sigma_{1.2}^2=\dfrac{8kT\gamma}{C_{P,Q}}\cdot\dfrac{g_{m1,2}V_{THN}}{I_{CM}}$$

加上 $S_1-S_2$ 的 $kT/C$ 噪声的贡献，除以电压增益的平方，同时写作 $g_{m1,2} \approx 2I_{CM}/(V_{GS}-V_{THN})_{1,2}$，则最终该模式下的的输入参考噪声为：

$$\overline{V_{n,in}^2}=\dfrac{(V_{GS}-V_{THN})_{1,2}}{V_{THN}}\cdot [\dfrac{4kT\gamma}{C_{P,Q}}+\dfrac{(V_{GS}-V_{THN})_{1,2}}{V_{THN}}\cdot \dfrac{kT}{2C_{P,Q}}]$$

方括号中的第一项 $M_1-M_2$ 贡献的噪声，通常比第二项大8倍，其他噪声源的定量分析可以参考文献 [4]。

##### 锁存器噪声仿真方法

不限于 StrongARM 锁存器，比较器噪声仿真提出了有趣的问题。不同于小信号模拟电路，比较器并不直接提供一个输出噪声和一个输出噪声等效到输入需要除以的增益。简单来说，我们可以将比较器置于亚稳态条件（metastable condition）下进行小信号分析，但应考虑 StrongARM 锁存器的开关切换行为和噪声注入在输出开始变化之前就已经完成了。

![strongarm_fig6.png](https://i.loli.net/2020/02/29/kXN4WHxCpjm21vT.png)

比较器的噪声系统仿真如下，见 Fig.6：

- 仿真器设置
  - 带有噪声的瞬态仿真
  - 假设比较器失调和差分输入电压为 0
  - 给予仿真器多次有效的时钟
  - 电路中的高斯噪声使得输出最终会从亚稳态中恢复，产生 0/1 输出的概率相等
- 应用一个小的差分输入 $V_S$（若干 mV），并重复仿真
  - 因为 $V_S$ 影响比较器的决策，“ 1”和“ 0” 出现的概率不相等
  - 默认情况下，$V_S$ 为正数，输出为 1
  - 仅当以输入为基准的噪声小于负数 $-V_S$ 时才输出 0
- 通过大量的时钟周期的仿真结果，推算噪声高斯改论分布
  - 预测输出 0 的个数正比于高斯概率分布函数 $f_x(x)$  从 $-V_S$ 至 $+\infty$ 的面积
  - 根据仿真中 0/1 出现的次数 $n_0/n_1$，可以得到
  $$\dfrac{\int_{-\infty}^{-V_S}f_x(x)dx}{1-\int^{-V_S}_{-\infty}f_x(x)dx}=\dfrac{n_0}{n_1}$$
  - 输入参考噪声电压的平方即为 $f_x(x)$ 的方差
  - $V_S$ 的选择应该满足
    - $V_S$ 足够大，使得 $n_0/n_1$ 远离 1
    - $V_S$ 足够小，避免 $n_0$ 和 $n_1$ 出现的次数过少而不具有统计意义

#### 回踢和电源瞬态 kickback and supply transients

StrongARM 锁存器工作时会从输入和电路汲取较大的瞬态电流。当大量比较器同时工作时，如 flash ADC 中的情况，这会造成较大的问题。

##### 回踢

如 Fig.7 所示，输入产生的“回踢”电流来自多种机制，同时包括差分和共模分量。前者主要表现为$V_P, V_Q$ 以不相等的速率下降至地，并通过 $C_{GD1},C_{GD2}$耦合至输入。当 $M_1,M_2$ 进入线性区域，并且其栅极-漏极电容增加时，这种影响变得更加明显。 共模 CM 的反冲噪声电流大得多，并且当 $M_7$ 开启时，开始从 $C_{GS1},C_{GS2}$ 汲取其漏极电流，而当它关闭时，CK 通过 $C_{GD7}(\approx C_{GS7})$ 耦合到 $C_{GS1},C_{GS2}$。

通过为输入器件的漏极路径而非源极路径提供时钟，可以降低回踢噪声。如 Fig.8(a) 所示，这种机构使用了 $M_7,M_8$ 来控制锁存器。但是，由于 $M_1,M2$ 在放大模式下工作在线性区，因此降低了回踢噪声，但代价是输入失调较高。通过将 $M_3-M_4$ 和 $M_7-M_8$ 变宽可以避免此问题，但是，如 Fig.8(b) 所示，在预充电模式下，$A$ 或 $B$ 处的缓慢放电会导致 $V_P$ 和 $V_Q$ 较大的动态失调之间明显失衡。

![strongarm_fig7.png](https://i.loli.net/2020/03/01/JLge9ba1uFkExN2.png)

##### 电源瞬态

如 Fig.1(b) 所示，电源瞬态电流源自 $S_1 - S_4$ 的预充电行为。如果 $CK$ 快速下降，$S_1 - S_4$ 中的3个立即进入饱和区（第四个处于线性区域，因为其漏极电压等于 $V_{DD}$），并且从 $V_{DD}$ 汲取大电流。设计的关键点是，由于电源的阻抗较低，即使是平均功率低的设计，可能仍从电源汲取高峰值的电流流。

![strongarm_fig8.png](https://i.loli.net/2020/03/01/K9j2T8Z6ykExR3s.png)

## References

> - [The StrongARM Latch](http://ieeexplore.ieee.org/document/7130773/)
> - [[4] Noise analysis of regenerative comparators for reconfigurable ADC architectures](https://ieeexplore.ieee.org/document/4446769)